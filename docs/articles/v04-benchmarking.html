<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MSnbase2 benchmarking • MSnbase</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MSnbase2 benchmarking">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MSnbase</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">2.7.10</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/v01-MSnbase-demo.html">MSnbase: MS data processing, visualisation and quantification</a>
    </li>
    <li>
      <a href="../articles/v02-MSnbase-io.html">MSnbase IO capabilities</a>
    </li>
    <li>
      <a href="../articles/v03-MSnbase-centroiding.html">MSnbase: centroiding of profile-mode MS data</a>
    </li>
    <li>
      <a href="../articles/v04-benchmarking.html">MSnbase2 benchmarking</a>
    </li>
    <li>
      <a href="../articles/v05-MSnbase-development.html">A short introduction to *MSnbase* development</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lgatto/MSnbase">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>MSnbase2 benchmarking</h1>
                        <h4 class="author">Laurent Gatto</h4>
            <address class="author_afil">
      Computational Proteomics Unit, Cambridge, UK<br><h4 class="author">Johannes Rainer</h4>
            <address class="author_afil">
      Center for Biomedicine, EURAC, Bolzano, Italy<br><small class="dont-index">Source: <a href="https://github.com/lgatto/MSnbase/blob/master/vignettes/v04-benchmarking.Rmd"><code>vignettes/v04-benchmarking.Rmd</code></a></small>
      <div class="hidden name"><code>v04-benchmarking.Rmd</code></div>

    </address>
</address>
</div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>In this vignette, we will document various timings and benchmarkings of the recent <em><a href="https://bioconductor.org/packages/3.8/MSnbase">MSnbase</a></em> development (aka <code>MSnbase2</code>), that focuses on <em>on-disk</em> data access (as opposed to <em>in-memory</em>). More details about the new implementation will be documented elsewhere.</p>
<p>As a benchmarking dataset, we are going to use a subset of an TMT 6-plex experiment acquired on an LTQ Orbitrap Velos, that is distributed with the <em><a href="https://bioconductor.org/packages/3.8/msdata">msdata</a></em> package</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"msdata"</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">f &lt;-<span class="st"> </span>msdata<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/msdata/topics/proteomics">proteomics</a></span>(<span class="dt">full.names =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">                        <span class="dt">pattern =</span> <span class="st">"TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.gz"</span>)</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">basename</span>(f)</a></code></pre></div>
<pre><code>## [1] "TMT_Erwinia_1uLSike_Top10HCD_isol2_45stepped_60min_01.mzML.gz"</code></pre>
<p>We need to load the <em><a href="https://bioconductor.org/packages/3.8/MSnbase">MSnbase</a></em> package and set the session-wide verbosity flag to <code>FALSE</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"MSnbase"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="../reference/MSnbaseOptions.html">setMSnbaseVerbose</a></span>(<span class="ot">FALSE</span>)</a></code></pre></div>
</div>
<div id="benchmarking" class="section level1">
<h1 class="hasAnchor">
<a href="#benchmarking" class="anchor"></a>Benchmarking</h1>
<div id="reading-data" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-data" class="anchor"></a>Reading data</h2>
<p>We first read the data using the original behaviour <code>readMSData</code> function by setting the <code>mode</code> argument to <code>"inMemory"</code> to generates an in-memory representation of the MS2-level raw data and measure the time needed for this operation.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">system.time</span>(inmem &lt;-<span class="st"> </span><span class="kw"><a href="../reference/readMSData.html">readMSData</a></span>(f, <span class="dt">msLevel =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">                                <span class="dt">mode =</span> <span class="st">"inMemory"</span>,</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">                                <span class="dt">centroided =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   3.206   0.030   3.232</code></pre>
<p>Next, we use the <code>readMSData</code> function to generate an on-disk representation of the same data by setting <code>mode = "onDisk"</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">system.time</span>(ondisk &lt;-<span class="st"> </span><span class="kw"><a href="../reference/readMSData.html">readMSData</a></span>(f, <span class="dt">msLevel =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">                                  <span class="dt">mode =</span> <span class="st">"onDisk"</span>,</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">                                  <span class="dt">centroided =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   1.203   0.017   1.217</code></pre>
<p>Creating the on-disk experiment is considerable faster and scales to much bigger, multi-file data, both in terms of object creation time, but also in terms of object size (see next section). We must of course make sure that these two datasets are equivalent:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">all.equal</span>(inmem, ondisk)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
<div id="data-size" class="section level2">
<h2 class="hasAnchor">
<a href="#data-size" class="anchor"></a>Data size</h2>
<p>To compare the size occupied in memory of these two objects, we are going to use the <code>object_size</code> function from the <em><a href="https://CRAN.R-project.org/package=pryr">pryr</a></em> package, which accounts for the data (the spectra) in the <code>assayData</code> environment (as opposed to the <code>object.size</code> function from the <code>utils</code> package).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"pryr"</span>)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw"><a href="http://www.rdocumentation.org/packages/pryr/topics/object_size">object_size</a></span>(inmem)</a></code></pre></div>
<pre><code>## 2.77 MB</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/pryr/topics/object_size">object_size</a></span>(ondisk)</a></code></pre></div>
<pre><code>## 220 kB</code></pre>
<p>The difference is explained by the fact that for <code>ondisk</code>, the spectra are not created and stored in memory; they are access on disk when needed, such as for example for plotting:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/plot-methods.html">plot</a></span>(inmem[[<span class="dv">200</span>]], <span class="dt">full =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw"><a href="../reference/plot-methods.html">plot</a></span>(ondisk[[<span class="dv">200</span>]], <span class="dt">full =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<div class="figure">
<img src="v04-benchmarking_files/figure-html/plot1-1.png" alt="Plotting in-memory and on-disk spectra" width="700"><p class="caption">
Plotting in-memory and on-disk spectra
</p>
</div>
</div>
<div id="accessing-spectra" class="section level2">
<h2 class="hasAnchor">
<a href="#accessing-spectra" class="anchor"></a>Accessing spectra</h2>
<p>The drawback of the on-disk representation is when the spectrum data has to actually be accessed. To compare access time, we are going to use the <em><a href="https://CRAN.R-project.org/package=microbenchmark">microbenchmark</a></em> and repeat access 10 times to compare access to all 451 and a single spectrum in-memory (i.e. pre-loaded and constructed) and on-disk (i.e. on-the-fly access).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">library</span>(<span class="st">"microbenchmark"</span>)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">mb &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/microbenchmark/topics/microbenchmark">microbenchmark</a></span>(<span class="kw"><a href="../reference/pSet-class.html">spectra</a></span>(inmem),</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">                     inmem[[<span class="dv">200</span>]],</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">                     <span class="kw"><a href="../reference/pSet-class.html">spectra</a></span>(ondisk),</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">                     ondisk[[<span class="dv">200</span>]],</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">                     <span class="dt">times =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">mb</a></code></pre></div>
<pre><code>## Unit: microseconds
##             expr        min         lq        mean     median         uq
##   spectra(inmem)     64.385     70.265    112.0319    109.179    162.906
##     inmem[[200]]     19.874     33.473     41.7093     43.040     44.128
##  spectra(ondisk) 255562.610 256925.773 258810.8903 257948.671 259902.658
##    ondisk[[200]] 119950.748 120767.306 121609.3126 121776.447 122165.423
##         max neval
##     176.832    10
##      71.787    10
##  264492.415    10
##  123061.737    10</code></pre>
<p>While it takes order or magnitudes more time to access the data on-the-fly rather than a pre-generated spectrum, accessing all spectra is only marginally slower than accessing all spectra, as most of the time is spent preparing the file for access, which is done only once.</p>
<p>On-disk access performance will depend on the read throughput of the disk. A comparison of the data import of the above file from an internal solid state drive and from an USB3 connected hard disk showed only small differences for the <code>onDisk</code> mode (1.07 <em>vs</em> 1.36 seconds), while no difference were observed for accessing individual or all spectra. Thus, for this particular setup, performance was about the same for SSD and HDD. This might however not apply to setting in which data import is performed in parallel from multiple files.</p>
<p>Data access does not prohibit interactive usage, such as plotting, for example, as it is about 1/2 seconds, which is an operation that is relatively rare, compared to subsetting and filtering, which are faster for on-disk data:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">i &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw"><a href="../reference/pSet-class.html">length</a></span>(inmem), <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">system.time</span>(inmem[i])</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.063   0.000   0.062</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw">system.time</span>(ondisk[i])</a></code></pre></div>
<pre><code>##    user  system elapsed 
##    0.01    0.00    0.01</code></pre>
<p>Operations on the spectra data, such as peak picking, smoothing, cleaning, … are cleverly cached and only applied when the data is accessed, to minimise file access overhead. Finally, specific operations such as for example quantitation (see next section) are optimised for speed.</p>
</div>
<div id="ms2-quantitation" class="section level2">
<h2 class="hasAnchor">
<a href="#ms2-quantitation" class="anchor"></a>MS2 quantitation</h2>
<p>Below, we perform TMT 6-plex reporter ions quantitation on the first 100 spectra and verify that the results are identical (ignoring feature names).</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="kw">system.time</span>(eim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quantify-methods.html">quantify</a></span>(inmem[<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>], <span class="dt">reporters =</span> TMT6,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                            <span class="dt">method =</span> <span class="st">"max"</span>))</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.180   0.064   0.890</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="kw">system.time</span>(eod &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quantify-methods.html">quantify</a></span>(ondisk[<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>], <span class="dt">reporters =</span> TMT6,</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">                            <span class="dt">method =</span> <span class="st">"max"</span>))</a></code></pre></div>
<pre><code>##    user  system elapsed 
##   0.188   0.007   0.194</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">all.equal</span>(eim, eod, <span class="dt">check.attributes =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
</div>
</div>
<div id="notable-differences-on-disk-and-in-memory-implementations" class="section level1">
<h1 class="hasAnchor">
<a href="#notable-differences-on-disk-and-in-memory-implementations" class="anchor"></a>Notable differences <em>on-disk</em> and <em>in-memory</em> implementations</h1>
<p>The <code>MSnExp</code> and <code>OnDiskMSnExp</code> documentation files and the <em>MSnbase developement</em> vignette provide more information about implementation details.</p>
<div id="ms-levels" class="section level2">
<h2 class="hasAnchor">
<a href="#ms-levels" class="anchor"></a>MS levels</h2>
<p><em>On-disk</em> support multiple MS levels in one object, while <em>in-memory</em> only supports a single level. While support for multiple MS levels could be added to the in-memory back-end, memory constrains make this pretty-much useless and will most likely never happen.</p>
</div>
<div id="serialisation" class="section level2">
<h2 class="hasAnchor">
<a href="#serialisation" class="anchor"></a>Serialisation</h2>
<p><em>In-memory</em> objects can be <code>save()</code>ed and <code>load()</code>ed, while <em>on-disk</em> can’t. As a workaround, the latter can be coerced to <em>in-memory</em> instances with <code><a href="../reference/mzRident2dfr.html">as(, "MSnExp")</a></code>. We would need <code>mzML</code> write support in <em><a href="https://bioconductor.org/packages/3.8/mzR">mzR</a></em> to be able to implement serialisation for <em>on-disk</em> data.</p>
</div>
<div id="data-processing" class="section level2">
<h2 class="hasAnchor">
<a href="#data-processing" class="anchor"></a>Data processing</h2>
<p>Whenever possible, accessing and processing <em>on-disk</em> data is delayed (<em>lazy</em> processing). These operations are stored in a <em>processing queue</em> until the spectra are effectively instantiated.</p>
</div>
<div id="validity" class="section level2">
<h2 class="hasAnchor">
<a href="#validity" class="anchor"></a>Validity</h2>
<p>The <em>on-disk</em> <code>validObject</code> method doesn’t verify the validity on the spectra (as there aren’t any to check). The <code>validateOnDiskMSnExp</code> function, on the other hand, instantiates all spectra and checks their validity (in addition to calling <code>validObject</code>).</p>
</div>
</div>
<div id="conclusions" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusions" class="anchor"></a>Conclusions</h1>
<p>This document focuses on speed and size improvements of the new on-disk <code>MSnExp</code> representation. The extend of these improvements will substantially increase for larger data.</p>
<p>For general functionality about the on-disk <code>MSnExp</code> data class and <em><a href="https://bioconductor.org/packages/3.8/MSnbase">MSnbase</a></em> in general, see other vignettes available with</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">vignette</span>(<span class="dt">package =</span> <span class="st">"MSnbase"</span>)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#benchmarking">Benchmarking</a><ul class="nav nav-pills nav-stacked">
<li><a href="#reading-data">Reading data</a></li>
      <li><a href="#data-size">Data size</a></li>
      <li><a href="#accessing-spectra">Accessing spectra</a></li>
      <li><a href="#ms2-quantitation">MS2 quantitation</a></li>
      </ul>
</li>
      <li>
<a href="#notable-differences-on-disk-and-in-memory-implementations">Notable differences <em>on-disk</em> and <em>in-memory</em> implementations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#ms-levels">MS levels</a></li>
      <li><a href="#serialisation">Serialisation</a></li>
      <li><a href="#data-processing">Data processing</a></li>
      <li><a href="#validity">Validity</a></li>
      </ul>
</li>
      <li><a href="#conclusions">Conclusions</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Laurent Gatto, Johannes Rainer, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
