<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Combine signal from consecutive spectra of LCMS experiments — combineSpectraMovingWindow • MSnbase</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Combine signal from consecutive spectra of LCMS experiments — combineSpectraMovingWindow"><meta name="description" content="combineSpectraMovingWindow combines signal from consecutive spectra within
a file. The resulting MSnExp has the same total number of spectra than the
original object, but with each individual's spectrum information
representing aggregated data from the original spectrum and its neighboring
spectra. This is thus equivalent with a smoothing of the data in retention
time dimension.
Note that the function returns always a MSnExp object, even if x was an
OnDiskMSnExp object."><meta property="og:description" content="combineSpectraMovingWindow combines signal from consecutive spectra within
a file. The resulting MSnExp has the same total number of spectra than the
original object, but with each individual's spectrum information
representing aggregated data from the original spectrum and its neighboring
spectra. This is thus equivalent with a smoothing of the data in retention
time dimension.
Note that the function returns always a MSnExp object, even if x was an
OnDiskMSnExp object."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">MSnbase</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.31.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/v01-MSnbase-demo.html">MSnbase: MS data processing, visualisation and quantification</a></li>
    <li><a class="dropdown-item" href="../articles/v02-MSnbase-io.html">MSnbase IO capabilities</a></li>
    <li><a class="dropdown-item" href="../articles/v03-MSnbase-centroiding.html">MSnbase: centroiding of profile-mode MS data</a></li>
    <li><a class="dropdown-item" href="../articles/v04-benchmarking.html">MSnbase benchmarking</a></li>
    <li><a class="dropdown-item" href="../articles/v05-MSnbase-development.html">A short introduction to *MSnbase* development</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lgatto/MSnbase/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Combine signal from consecutive spectra of LCMS experiments</h1>
      <small class="dont-index">Source: <a href="https://github.com/lgatto/MSnbase/blob/master/R/functions-MSnExp.R" class="external-link"><code>R/functions-MSnExp.R</code></a></small>
      <div class="d-none name"><code>combineSpectraMovingWindow.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>combineSpectraMovingWindow</code> combines signal from consecutive spectra within
a file. The resulting <code>MSnExp</code> has the same total number of spectra than the
original object, but with each individual's spectrum information
representing aggregated data from the original spectrum and its neighboring
spectra. This is thus equivalent with a smoothing of the data in retention
time dimension.</p>
<p>Note that the function returns always a <code>MSnExp</code> object, even if <code>x</code> was an
<code>OnDiskMSnExp</code> object.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">combineSpectraMovingWindow</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  halfWindowSize <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  intensityFun <span class="op">=</span> <span class="fu">base</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span>,</span>
<span>  mzd <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  timeDomain <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  weighted <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  ppm <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  BPPARAM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">bpparam</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p><code>MSnExp</code> or <code>OnDiskMSnExp</code> object.</p></dd>


<dt id="arg-halfwindowsize">halfWindowSize<a class="anchor" aria-label="anchor" href="#arg-halfwindowsize"></a></dt>
<dd><p><code>integer(1)</code> with the half window size for the moving
window.</p></dd>


<dt id="arg-intensityfun">intensityFun<a class="anchor" aria-label="anchor" href="#arg-intensityfun"></a></dt>
<dd><p><code>function</code> to aggregate the intensity values per m/z
group. Should be a function or the name of a function. The function is
expected to return a <code>numeric(1)</code>.</p></dd>


<dt id="arg-mzd">mzd<a class="anchor" aria-label="anchor" href="#arg-mzd"></a></dt>
<dd><p><code>numeric(1)</code> defining the maximal m/z difference below which
mass peaks are considered to represent the same ion/mass peak.
Intensity values for such grouped mass peaks are aggregated. If not
specified this value is estimated from the distribution of differences
of m/z values from the provided spectra (see details).</p></dd>


<dt id="arg-timedomain">timeDomain<a class="anchor" aria-label="anchor" href="#arg-timedomain"></a></dt>
<dd><p><code>logical(1)</code> whether definition of the m/z values to be
combined into one m/z is performed on m/z values
(<code>timeDomain = FALSE</code>) or on <code>sqrt(mz)</code> (<code>timeDomain = TRUE</code>).
Profile data from TOF MS instruments should be aggregated based
on the time domain (see details). Note that a pre-defined <code>mzd</code> should
also be estimated on the square root of m/z values if
<code>timeDomain = TRUE</code>.</p></dd>


<dt id="arg-weighted">weighted<a class="anchor" aria-label="anchor" href="#arg-weighted"></a></dt>
<dd><p><code>logical(1)</code> whether m/z values per m/z group should be
aggregated with an intensity-weighted mean. The default is to report
the mean m/z.</p></dd>


<dt id="arg-ppm">ppm<a class="anchor" aria-label="anchor" href="#arg-ppm"></a></dt>
<dd><p><code>numeric(1)</code> to define an m/z relative deviation. Note that if
only <code>ppm</code> should be considered but not <code>mzd</code>, <code>mzd</code> should be set to
<code>0</code> (i.e. <code>mzd = 0</code>). This parameter is directly passed to
<code><a href="meanMzInts.html">meanMzInts()</a></code>.</p></dd>


<dt id="arg-bpparam">BPPARAM<a class="anchor" aria-label="anchor" href="#arg-bpparam"></a></dt>
<dd><p>parallel processing settings.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>MSnExp</code> with the same number of spectra than <code>x</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The method assumes same ions being measured in consecutive scans (i.e. LCMS
data) and thus combines their signal which can increase the increase the
signal to noise ratio.</p>
<p>Intensities (and m/z values) for signals with the same m/z value in
consecutive scans are aggregated using the <code>intensityFun</code>.
m/z values of intensities from consecutive scans will never be exactly
identical, even if they represent signal from the same ion. The function
determines thus internally a similarity threshold based on differences
between m/z values within and between spectra below which m/z values are
considered to derive from the same ion. For robustness reasons, this
threshold is estimated on the 100 spectra with the largest number of
m/z - intensity pairs (i.e. mass peaks).</p>
<p>See <code><a href="meanMzInts.html">meanMzInts()</a></code> for details.</p>
<p>Parameter <code>timeDomain</code>: by default, m/z-intensity pairs from consecutive
scans to be aggregated are defined based on the square root of the m/z
values. This is because it is highly likely that in all QTOF MS instruments
data is collected based on a timing circuit (with a certain variance) and
m/z values are later derived based on the relationship <code>t = k * sqrt(m/z)</code>.
Differences between individual m/z values will thus be dependent on the
actual m/z value causing both the difference between m/z values and their
scattering being different in the lower and upper m/z range. Determining
m/z values to be combined on the <code>sqrt(mz)</code> reduces this dependency. For
non-QTOF MS data <code>timeDomain = FALSE</code> might be used instead.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>The function has to read all data into memory for the spectra combining
and thus the memory requirements of this function are high, possibly
preventing its usage on large experimental data. In these cases it is
suggested to perform the combination on a per-file basis and save the
results using the <code><a href="writeMSData.html">writeMSData()</a></code> function afterwards.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="meanMzInts.html">meanMzInts()</a></code> for the function combining spectra provided in
a <code>list</code>.</p>
<p><code><a href="estimateMzScattering.html">estimateMzScattering()</a></code> for a function to estimate m/z value scattering in
consecutive spectra.</p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Johannes Rainer, Sigurdur Smarason</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lgatto.github.io/MSnbase">MSnbase</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">msdata</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Read a profile-mode LC-MS data file.</span></span></span>
<span class="r-in"><span><span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sciex"</span>, package <span class="op">=</span> <span class="st">"msdata"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu"><a href="readMSData.html">readMSData</a></span><span class="op">(</span><span class="va">fl</span>, mode <span class="op">=</span> <span class="st">"onDisk"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Subset the object to the retention time range that includes the signal</span></span></span>
<span class="r-in"><span><span class="co">## for proline. This is done for performance reasons.</span></span></span>
<span class="r-in"><span><span class="va">rtr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">165</span>, <span class="fl">175</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">od</span> <span class="op">&lt;-</span> <span class="fu"><a href="MSnExp-class.html">filterRt</a></span><span class="op">(</span><span class="va">od</span>, <span class="va">rtr</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Combine signal from neighboring spectra.</span></span></span>
<span class="r-in"><span><span class="va">od_comb</span> <span class="op">&lt;-</span> <span class="fu">combineSpectraMovingWindow</span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The combined spectra have the same number of spectra, same number of</span></span></span>
<span class="r-in"><span><span class="co">## mass peaks per spectra, but the signal is larger in the combined object.</span></span></span>
<span class="r-in"><span><span class="fu"><a href="pSet-class.html">length</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 36</span>
<span class="r-in"><span><span class="fu"><a href="pSet-class.html">length</a></span><span class="op">(</span><span class="va">od_comb</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 36</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="Spectrum-class.html">peaksCount</a></span><span class="op">(</span><span class="va">od</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S592 F1.S593 F1.S594 F1.S595 F1.S596 F1.S597 F1.S598 F1.S599 F1.S600 F1.S601 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     681     745     763     848     713     963    1126    1016     756     796 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S602 F1.S603 F1.S604 F1.S605 F1.S606 F1.S607 F1.S608 F1.S609 F1.S610 F1.S611 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     861     830     710     815     739     693     659     734    1054    1246 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S612 F1.S613 F1.S614 F1.S615 F1.S616 F1.S617 F1.S618 F1.S619 F1.S620 F1.S621 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    1509    1590    1943    2130    2166    2923    2816    2123    1744    1704 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S622 F1.S623 F1.S624 F1.S625 F1.S626 F1.S627 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    2073    2015    1910    1859    1853    1762 </span>
<span class="r-in"><span><span class="fu"><a href="Spectrum-class.html">peaksCount</a></span><span class="op">(</span><span class="va">od_comb</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S592 F1.S593 F1.S594 F1.S595 F1.S596 F1.S597 F1.S598 F1.S599 F1.S600 F1.S601 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     681     745     763     848     713     963    1126    1016     756     796 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S602 F1.S603 F1.S604 F1.S605 F1.S606 F1.S607 F1.S608 F1.S609 F1.S610 F1.S611 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     861     830     710     815     739     693     659     734    1054    1246 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S612 F1.S613 F1.S614 F1.S615 F1.S616 F1.S617 F1.S618 F1.S619 F1.S620 F1.S621 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    1509    1590    1943    2130    2166    2923    2816    2123    1744    1704 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> F1.S622 F1.S623 F1.S624 F1.S625 F1.S626 F1.S627 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    2073    2015    1910    1859    1853    1762 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Comparing the chromatographic signal for proline (m/z ~ 116.0706)</span></span></span>
<span class="r-in"><span><span class="co">## before and after spectra data combination.</span></span></span>
<span class="r-in"><span><span class="va">mzr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">116.065</span>, <span class="fl">116.075</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">chr</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-MSnExp-method.html">chromatogram</a></span><span class="op">(</span><span class="va">od</span>, rt <span class="op">=</span> <span class="va">rtr</span>, mz <span class="op">=</span> <span class="va">mzr</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">chr_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="chromatogram-MSnExp-method.html">chromatogram</a></span><span class="op">(</span><span class="va">od_comb</span>, rt <span class="op">=</span> <span class="va">rtr</span>, mz <span class="op">=</span> <span class="va">mzr</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot-methods.html">plot</a></span><span class="op">(</span><span class="va">chr</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="plot-methods.html">plot</a></span><span class="op">(</span><span class="va">chr_comb</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="combineSpectraMovingWindow-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co">## Chromatographic data is "smoother" after combining.</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Laurent Gatto, Johannes Rainer, Sebastian Gibb.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.9000.</p>
</div>

    </footer></div>





  </body></html>

