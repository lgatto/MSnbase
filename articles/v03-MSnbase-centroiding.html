<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MSnbase: centroiding of profile-mode MS data • MSnbase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MSnbase: centroiding of profile-mode MS data">
<meta property="og:description" content="MSnbase">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MSnbase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.15.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/v01-MSnbase-demo.html">MSnbase: MS data processing, visualisation and quantification</a>
    </li>
    <li>
      <a href="../articles/v02-MSnbase-io.html">MSnbase IO capabilities</a>
    </li>
    <li>
      <a href="../articles/v03-MSnbase-centroiding.html">MSnbase: centroiding of profile-mode MS data</a>
    </li>
    <li>
      <a href="../articles/v04-benchmarking.html">MSnbase benchmarking</a>
    </li>
    <li>
      <a href="../articles/v05-MSnbase-development.html">A short introduction to *MSnbase* development</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/lgatto/MSnbase/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MSnbase: centroiding of profile-mode MS data</h1>
                        <h4 class="author">Johannes Rainer</h4>
                        
      
      <small class="dont-index">Source: <a href="https://github.com/lgatto/MSnbase/blob/master/vignettes/v03-MSnbase-centroiding.Rmd"><code>vignettes/v03-MSnbase-centroiding.Rmd</code></a></small>
      <div class="hidden name"><code>v03-MSnbase-centroiding.Rmd</code></div>

    </div>

    
        <div class="abstract">
      <p class="abstract">Abstract</p>
      This vignette describes the use of the MSnbase package for centroiding of profile-mode mass spectrometry data.
    </div>
    
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelector("h1").className = "title";
});
</script><script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  var links = document.links;  
  for (var i = 0, linksLength = links.length; i < linksLength; i++)
    if (links[i].hostname != window.location.hostname)
      links[i].target = '_blank';
});
</script><div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Mass spectrometry measures data in so called <em>profile mode</em>, were the signal corresponding to a specific ion is distributed around the ion’s actual m/z value <span class="citation">(Smith et al. 2014)</span>. The accuracy of that signal depends on the resolution and settings of the instrument. Profile mode data can be processed into <em>centroid</em> data by retaining only a single, representative value, typically the local maximum of the distribution of data points. This <em>centroiding</em> substantially reduces the amount of data without much loss of information. Certain algorithms, such as the <em>centWave</em> method in the <em><a href="https://bioconductor.org/packages/3.12/xcms">xcms</a></em> package for chromatographic peak detection in LC-MS experiments or proteomics search engines that match MS2 spectra to peptides, require the data to be in centroid mode. In this vignette, we will focus on metabolomics data.</p>
<p>Many manufacturers apply centroiding of the profile data, either directly during the acquisition or immediately thereafter so that the user immediately receives processed data. Alternatively, third party software, such as <code>msconvert</code> from the <code>proteowizard</code> suite <span class="citation">(Chambers et al. 2012)</span> allow to apply various data centroiding algorithms, including vendor methods. In some cases however, the software provided by some vendors generate centroided data of poor quality. <code>MSnbase</code> also provides some functionality to perform centroiding of profile MS data. These processed data can then be further quantified or analysed within R or serialised to <em>mzML</em> files, and used as input for other software.</p>
</div>
<div id="centroiding-of-profile-mode-ms-data" class="section level1">
<h1 class="hasAnchor">
<a href="#centroiding-of-profile-mode-ms-data" class="anchor"></a>Centroiding of profile-mode MS data</h1>
<p>In this vignette we use a subset of a metabolomics profile-mode LC-MS data of pooled human serum samples measured on a AB Sciex TripleTOF 5600+ mass spectrometer (the employed chromatography was a hydrophilic interaction high-performance liquid chromatography (HILIC HPLC)). The mzML file contains profile mode data for an m/z range from 105 to 130 and a retention time from 0 to 240 seconds. For more details on the sample see <code><a href="https://rdrr.io/pkg/msdata/man/sciexdata.html">?msdata::sciexdata</a></code>. Below we load the required packages and read the MS data.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"MSnbase"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"msdata"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"magrittr"</span>)

<span class="no">fl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"sciex"</span>, <span class="kw">package</span> <span class="kw">=</span> <span class="st">"msdata"</span>), <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)[<span class="fl">2</span>]
<span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span>(<span class="no">fl</span>)</pre></body></html></div>
<pre><code>## [1] "20171016_POOL_POS_3_105-134.mzML"</code></pre>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">data_prof</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/readMSData.html">readMSData</a></span>(<span class="no">fl</span>, <span class="kw">mode</span> <span class="kw">=</span> <span class="st">"onDisk"</span>, <span class="kw">centroided</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<p>We next extract the profile MS data for the [M+H]+ adduct of serine with the expected m/z of 106.049871. We thus filter the <code>data_prof</code> object using an m/z range containing the signal for the metabolite and a retention time window from 175 to 187 seconds corresponding to the time when the analyte elutes from the LC.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co">## Define the mz and retention time ranges</span>
<span class="no">serine_mz</span> <span class="kw">&lt;-</span> <span class="fl">106.049871</span>
<span class="no">mzr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">serine_mz</span> - <span class="fl">0.01</span>, <span class="no">serine_mz</span> + <span class="fl">0.01</span>)
<span class="no">rtr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">175</span>, <span class="fl">187</span>)

<span class="co">## Filtering the object</span>
<span class="no">serine</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">mzr</span>)</pre></body></html></div>
<p>We can now plot the profile MS data for serine.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">serine</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">serine_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/serine-plot-1.png" alt="MS profile data for serine. Upper panel shows the base peak chromatogram (BPC), lower panel the individual signals in the retention time - m/z space. The horizontal dashed red line indicates the theoretical m/z of the [M+H]+ adduct of serine." width="700"><p class="caption">
MS profile data for serine. Upper panel shows the base peak chromatogram (BPC), lower panel the individual signals in the retention time - m/z space. The horizontal dashed red line indicates the theoretical m/z of the [M+H]+ adduct of serine.
</p>
</div>
<p>The lower panel in the plot above shows all the individual signal intensities measured by the mass spectrometer over the retention time and the m/z ranges of interest. The upper panel displays the <em>base peak chromatogram</em> (BPC), which represents the maximum signal (across the range of m/z values) for each discrete retention time. The rows of points in this lower panel indicate the resolution of the mass spectrometer while the columns of data points (i.e. the data collected for a discrete retention time point) represents the signal for the ion in one spectrum.</p>
<p>Below we plot the signal for one of of the 43 spectra containing signal for serine, the one at retention time 181.07</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">serine</span><span class="kw">[[</span><span class="fl">22</span>]])</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/serine-spectrum24-1.png" alt="On of the spectra for serine in profile mode." width="700"><p class="caption">
On of the spectra for serine in profile mode.
</p>
</div>
<p>The MS instrument recorded a signal along the m/z range in discrete intervals (which depend on the resolution of the instrument). The profile-mode signal of the serine ion at the respective retention time (the <em>mass peak</em>) consists therefore of multiple intensities that follow approximately a gaussian distribution.</p>
<p>As described in the introduction, centroiding aims to reduce this signal distribution to a single representative intensity, a single data point, for the ion in a spectrum. The simplest approach selects the largest intensity for each mass peak and report its intensity and m/z value. This can be done using the <code>pickPeaks</code> method with default parameters as shown below.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">data_cent</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>()

<span class="no">serine_cent</span> <span class="kw">&lt;-</span> <span class="no">data_cent</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">mzr</span>)

<span class="co">## Plot the centroided data for serine</span>
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">serine_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">serine_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/simple-pickPeaks-1.png" alt="Centroided data for serine." width="700"><p class="caption">
Centroided data for serine.
</p>
</div>
<p>After centroiding the data consists of a single intensity for each mass peak. In the example above the centroids from consecutive scans do however not have the same m/z value, but they fluctuate between the discrete m/z values defined by the instruments’s resolution. For lower intensity signals this variation can be substantial.</p>
<p>To further illustrate this, we plot below the centroided signal for the [M+H]+ ion of proline.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">prol_mz</span> <span class="kw">&lt;-</span> <span class="fl">116.070608</span>
<span class="no">prol_mzr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">prol_mz</span> - <span class="fl">0.01</span>, <span class="no">prol_mz</span> + <span class="fl">0.01</span>)
<span class="no">prol_rtr</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">165</span>, <span class="fl">175</span>)

<span class="no">proline</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">prol_rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">prol_mzr</span>)

<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">proline</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">prol_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/proline-1.png" alt="Centroided data for proline." width="700"><p class="caption">
Centroided data for proline.
</p>
</div>
<p>For proline, the centroids jump between 3 bins of m/z values in consecutive scans and the chromatographic data does not show a nice, regular peak shape. Additional data processing, such as data smoothing prior to centroiding and/or <em>refining</em> the centroid’s m/z can reduce these effects and improve overall data quality as we will see in the next section.</p>
</div>
<div id="improving-the-signal-quality" class="section level1">
<h1 class="hasAnchor">
<a href="#improving-the-signal-quality" class="anchor"></a>Improving the signal quality</h1>
<p>While the simple centroiding using <code>pickPeaks</code> as described in the previous section might be sufficient for many experiments and setups, MS data smoothing and refinement of the identified centroids’ m/z values can improve data quality.</p>
<div id="sec:smoothing" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:smoothing" class="anchor"></a>Data smoothing</h2>
<p>Raw mass spectrometry data is usually smoothed in m/z dimension by applying e.g. a Savitzky-Golay filter <span class="citation">(Savitzky and Golay 1964)</span> which reduces the noise and hence improves data quality. Below we use the <code>smooth</code> method to apply a Savitzky-Golay filter with a half-window size of 4 to the data within each spectrum (see <code><a href="../reference/smooth-methods.html">?smooth</a></code> for more details on the parameters).</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">data_sg</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/smooth-methods.html">smooth</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"SavitzkyGolay"</span>, <span class="kw">halfWindowSize</span> <span class="kw">=</span> <span class="fl">4L</span>)</pre></body></html></div>
<p>We next apply the simple peak picking on the smoothed data, filter the desired retention time and m/z ranges, and subsequently plot the such centroided data for serine.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">data_sg_cent</span> <span class="kw">&lt;-</span> <span class="no">data_sg</span> <span class="kw">%&gt;%</span>
    <span class="no">pickPeaks</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">mzr</span>)

<span class="co">## Plot the centroided data for serine</span>
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">data_sg_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">serine_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/smoothSG-pp-serine-1.png" alt="Centroided data for serine after smoothing with a Savitzky-Golay filter." width="700"><p class="caption">
Centroided data for serine after smoothing with a Savitzky-Golay filter.
</p>
</div>
<p>Smoothing the raw data prior to peak picking improved the quality of the centroided data of serine as well as proline as can be seen below.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">prol_sg_cent</span> <span class="kw">&lt;-</span> <span class="no">data_sg</span> <span class="kw">%&gt;%</span>
    <span class="no">pickPeaks</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">prol_rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">prol_mzr</span>)

<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">prol_sg_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">prol_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/smoothSG-pp-proline-1.png" alt="Centroided data for proline after smoothing with a Savitzky-Golay filter." width="700"><p class="caption">
Centroided data for proline after smoothing with a Savitzky-Golay filter.
</p>
</div>
<p>The smoothed centroided data for proline still show a systematic deviation of m/z values as well as poor chromatographic data.</p>
<p>In addition to smoothing the signal in m/z dimension, we can also smooth the signal along the retention time dimension using the <code>combineSpectraMovingWindow</code> function. This function aggregates signal for the same m/z value from neighbouring spectra in a moving window approach, thus smoothing the chromatographic data (by replacing the intensity in the middle spectrum by the average signal of all intensities for the m/z in the spectra within the defined window). To reduce the run-time of the example we apply the smoothing only to the profile-mode data for a retention time window containing proline (in a real data analysis this should be performed on the full data).</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co">## Subset to the data for proline, smooth it in rt dimension and</span>
<span class="co">## perform the centroiding</span>
<span class="no">proline_c_cent</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">prol_rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/combineSpectraMovingWindow.html">combineSpectraMovingWindow</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">prol_mzr</span>)</pre></body></html></div>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">proline_c_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">prol_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/proline-rtsmooth-1.png" alt="Centroided data for proline after smoothing in retention time dimension." width="700"><p class="caption">
Centroided data for proline after smoothing in retention time dimension.
</p>
</div>
<p>As can be seen above, smoothing in retention time dimension improves the chromatographic peak shape of proline.</p>
<p>Note however that, to combine data from multiple spectra, the <code>combineSpectraMovingWindow</code> function has to first load the full data into memory (i.e. it converts the <code>OnDiskMSnExp</code> object into a <code>MSnExp</code> object) and that it returns also a <code>MSnExp</code> object. In a real use case it is thus advisable to apply <code>combineSpectraMovingWindow</code> separately on each file of an experiment and to export the results as an <em>mzML</em> file using the <code>writeMSData</code> method.</p>
</div>
<div id="sec:refine" class="section level2">
<h2 class="hasAnchor">
<a href="#sec:refine" class="anchor"></a>Refinement of the centroid’s m/z values</h2>
<p>Thus far we applied only a simple peak picking strategy, but the <code>pickPeaks</code> method allows also to <em>refine</em> the identified centroid’s m/z value by considering also the signal from the full, or parts of the, mass peak. Currently two methods are implemented, <em>descendPeak</em> and <em>kNeighbors</em> that can be selected by passing either <code>refineMz = "descendPeak"</code> or <code>refineMz = "kNeighbors"</code> to the <code>pickPeaks</code> method. The m/z value of the reported centroid is calculated using an intensity-weighted mean of m/z-intensity values from the mass peak. This can improve the accuracy of the reported m/z values. The two methods differ only in the way in which the peak area for the final calculation is defined: <code>kNeighbors</code> takes the <code>k</code> m/z-intensity pairs (default <code>k = 2</code>) left and right of the centroid and <code>descendPeak</code> walks, on both sides from the centroid, down until the signal is below <code>signalPercentage</code>% of the centroid’s intensity (by default 33%), or until the signal increases again. All m/z intensity pairs within this range are used for the weighted average calculation of the centroid’s m/z value.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="co">## Use pickPeaks with descendPeak m/z refinement</span>
<span class="no">data_sg_cent_mz</span> <span class="kw">&lt;-</span> <span class="no">data_sg</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>(<span class="kw">refineMz</span> <span class="kw">=</span> <span class="st">"descendPeak"</span>)</pre></body></html></div>
<p>Below we first extract the data for serine and then plot the smoothed and centroided data without and with m/z refinement.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="co">## Extract the data for serine</span>
<span class="no">serine_sg_cent</span> <span class="kw">&lt;-</span> <span class="no">data_sg_cent</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">mzr</span>)

<span class="no">serine_sg_cent_mz</span> <span class="kw">&lt;-</span> <span class="no">data_sg_cent_mz</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">mzr</span>)

<span class="co">## Plot the data</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>:<span class="fl">4</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>))
<span class="co">## No m/z refinement</span>
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">serine_sg_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>, <span class="kw">layout</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">serine_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span> <span class="kw">=</span> <span class="fu"><a href="../reference/Spectrum-class.html">rtime</a></span>(<span class="no">serine_sg_cent</span>)[<span class="fl">22</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">3</span>)
<span class="co">## With m/z refinement</span>
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">serine_sg_cent_mz</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>, <span class="kw">layout</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">serine_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span> <span class="kw">=</span> <span class="fu"><a href="../reference/Spectrum-class.html">rtime</a></span>(<span class="no">serine_sg_cent_mz</span>)[<span class="fl">22</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/refineMz-serine-1.png" alt="Smoothed and centroided data for serine without (left) and with m/z refinement (right). The horizontal red dashed line indicates the theoretical m/z for the [M+H]+ ion and the vertical red dotted line the position of the largest signal for serine." width="700"><p class="caption">
Smoothed and centroided data for serine without (left) and with m/z refinement (right). The horizontal red dashed line indicates the theoretical m/z for the [M+H]+ ion and the vertical red dotted line the position of the largest signal for serine.
</p>
</div>
<p>As shown above (right), the accuracy of the centroided data with m/z refinement was improved, where the difference between the largest signal centroids’ m/z value and the theoretical m/z value for the [M+H]+ ion of serine is reduced.</p>
<p>For the simple peak picking on raw data the difference is:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co">## only centroided</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">data_cent</span>, <span class="no">rtr</span>), <span class="no">mzr</span>))<span class="kw">[[</span><span class="fl">22</span>]] - <span class="no">serine_mz</span></pre></body></html></div>
<pre><code>## [1] -0.0003682412</code></pre>
<p>Smoothing already improves the accuracy:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="co">## smoothed and centroided</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="no">serine_sg_cent</span>)<span class="kw">[[</span><span class="fl">22</span>]] - <span class="no">serine_mz</span></pre></body></html></div>
<pre><code>## [1] -0.0003682412</code></pre>
<p>And refining the m/z value during the centroiding can improve accuracy even more:</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co">## smoothed and centroided with m/z refinement</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="no">serine_sg_cent_mz</span>)<span class="kw">[[</span><span class="fl">22</span>]] - <span class="no">serine_mz</span></pre></body></html></div>
<pre><code>## [1] -0.0001703475</code></pre>
<p>Similarly, the m/z refinement also improved the accuracy for proline.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">proline_sg_cent</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/smooth-methods.html">smooth</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"SavitzkyGolay"</span>, <span class="kw">halfWindowSize</span> <span class="kw">=</span> <span class="fl">4L</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>() <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">prol_rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">prol_mzr</span>)

<span class="no">proline_sg_cent_mz</span> <span class="kw">&lt;-</span> <span class="no">data_prof</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/smooth-methods.html">smooth</a></span>(<span class="kw">method</span> <span class="kw">=</span> <span class="st">"SavitzkyGolay"</span>, <span class="kw">halfWindowSize</span> <span class="kw">=</span> <span class="fl">4L</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/pickPeaks-method.html">pickPeaks</a></span>(<span class="kw">refineMz</span> <span class="kw">=</span> <span class="st">"descendPeak"</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">prol_rtr</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="no">prol_mzr</span>)

<span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>:<span class="fl">4</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>))
<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">proline_sg_cent</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>, <span class="kw">layout</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">prol_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span> <span class="kw">=</span> <span class="fu"><a href="../reference/Spectrum-class.html">rtime</a></span>(<span class="no">proline_sg_cent_mz</span>)[<span class="fl">16</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">3</span>)

<span class="fu"><a href="../reference/plot-methods.html">plot</a></span>(<span class="no">proline_sg_cent_mz</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"XIC"</span>, <span class="kw">layout</span> <span class="kw">=</span> <span class="kw">NULL</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">h</span> <span class="kw">=</span> <span class="no">prol_mz</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">2</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="kw">v</span> <span class="kw">=</span> <span class="fu"><a href="../reference/Spectrum-class.html">rtime</a></span>(<span class="no">proline_sg_cent_mz</span>)[<span class="fl">16</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">lty</span> <span class="kw">=</span> <span class="fl">3</span>)</pre></body></html></div>
<div class="figure" style="text-align: center">
<img src="v03-MSnbase-centroiding_files/figure-html/refineMz-proline-1.png" alt="Smoothed and centroided data for proline without (left) and with m/z refinement (right). The horizontal red dashed line indicates the theoretical m/z for the [M+H]+ ion and the vertical red dotted line the position of the maximum signal." width="700"><p class="caption">
Smoothed and centroided data for proline without (left) and with m/z refinement (right). The horizontal red dashed line indicates the theoretical m/z for the [M+H]+ ion and the vertical red dotted line the position of the maximum signal.
</p>
</div>
<p>The difference between the m/z of the centroid with the largest signal and the theoretical m/z for the [M+H]+ ion of proline is shown below.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="co">## only centroiding</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="fu"><a href="../reference/trimMz-methods.html">filterMz</a></span>(<span class="fu"><a href="../reference/MSnExp-class.html">filterRt</a></span>(<span class="no">data_cent</span>, <span class="no">prol_rtr</span>), <span class="no">prol_mzr</span>))<span class="kw">[[</span><span class="fl">16</span>]] - <span class="no">prol_mz</span></pre></body></html></div>
<pre><code>## [1] 0.001577028</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="co">## smoothed and centroided</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="no">proline_sg_cent</span>)<span class="kw">[[</span><span class="fl">16</span>]] - <span class="no">prol_mz</span></pre></body></html></div>
<pre><code>## [1] 5.75261e-05</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="co">## smoothed and centroided with m/z refinement</span>
<span class="fu"><a href="../reference/Spectrum-class.html">mz</a></span>(<span class="no">proline_sg_cent_mz</span>)<span class="kw">[[</span><span class="fl">16</span>]] - <span class="no">prol_mz</span></pre></body></html></div>
<pre><code>## [1] -3.241556e-05</code></pre>
<p>Summarizing, smoothing raw profile MS data, e.g. by applying a Savitzky-Golay filter, improves quality considerably. Additional smoothing in retention time dimension can be advantageous too, specifically for the chromatographic peak shape. Accuracy can be further improved for smoothed profile MS data by refining the m/z value of the identified centroids.</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-Chambers:2012">
<p>Chambers, M C, B Maclean, R Burke, D Amodei, D L Ruderman, S Neumann, L Gatto, et al. 2012. “A Cross-Platform Toolkit for Mass Spectrometry and Proteomics.” <em>Nat Biotechnol</em> 30 (10): 918–20. <a href="https://doi.org/10.1038/nbt.2377" class="uri">https://doi.org/10.1038/nbt.2377</a>.</p>
</div>
<div id="ref-Savitzky:1964bn">
<p>Savitzky, Abraham, and M J E Golay. 1964. “Smoothing and Differentiation of Data by Simplified Least Squares Procedures.” <em>Analytical Chemistry</em> 36 (8): 1627–39.</p>
</div>
<div id="ref-Smith:2014di">
<p>Smith, Rob, Andrew D Mathis, Dan Ventura, and John T Prince. 2014. “Proteomics, lipidomics, metabolomics: a mass spectrometry tutorial from a computer scientist’s point of view.” <em>BMC Bioinformatics</em> 15 Suppl 7 (Suppl 7): S9.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Laurent Gatto, Johannes Rainer, Sebastian Gibb.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
